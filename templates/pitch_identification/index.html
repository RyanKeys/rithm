{% extends 'base.html' %}

{% block title %}Pitch Identification - Ear Training | R.I.T.H.M{% endblock %}
{% block meta_description %}Train your ear to identify musical pitches. Learn to recognize notes by ear with our interactive game.{% endblock %}

{% block content %}

<style>
  .game-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .stats-card {
    background: var(--bg-card);
    backdrop-filter: blur(12px);
    border: 1px solid var(--input-bg);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-value {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
  }
  
  .stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .audio-section {
    background: var(--bg-card);
    backdrop-filter: blur(12px);
    border: 1px solid var(--input-bg);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .play-btn {
    background: var(--warning);
    border: none;
    color: var(--text-primary);
    padding: 1rem 2rem;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .play-btn:hover {
    background: #d97706;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
  }
  
  .play-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .feedback-text {
    font-size: 1.2rem;
    font-weight: 500;
    padding: 1rem 2rem;
    border-radius: 12px;
    background: var(--input-bg);
    color: var(--text-secondary);
    display: inline-block;
  }
  
  .feedback-correct {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #6ee7b7;
  }
  
  .feedback-incorrect {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
  }
  
  .note-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .note-btn {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 1rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    min-width: 80px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .note-btn:hover {
    background: var(--border-color);
    border-color: var(--warning);
    transform: translateY(-2px);
  }
  
  .note-btn.correct {
    background: var(--success);
    border-color: var(--success);
  }
  
  .note-btn.incorrect {
    background: var(--danger);
    border-color: var(--danger);
  }
  
  .octave-indicator {
    font-size: 0.75rem;
    opacity: 0.7;
  }
</style>

<div class="game-container">
  
  <!-- Stats Card -->
  <div class="stats-card">
    <div class="row">
      <div class="col-4 stat-item">
        <div class="stat-value" id="score">0</div>
        <div class="stat-label">Score</div>
      </div>
      <div class="col-4 stat-item">
        <div class="stat-value" id="total">0</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="col-4 stat-item">
        <div class="stat-value" id="accuracy">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
    </div>
    <div class="text-center mt-3" id="submit-section" style="display: none;">
      <button id="submit-score" class="btn btn-success" onclick="submitToLeaderboard()">
        <i class="fas fa-trophy"></i> Submit to Leaderboard
      </button>
      <p class="mt-2 mb-0" style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">Minimum 10 attempts required</p>
    </div>
  </div>

  <!-- Audio Controls -->
  <div class="audio-section">
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
      Listen to the pitch and identify the note
    </p>
    <button id="play-btn" class="play-btn">
      <i class="fas fa-play"></i> Play Pitch
    </button>
  </div>

  <!-- Feedback -->
  <div class="d-flex justify-content-center mb-4">
    <span id="feedback" class="feedback-text">What note do you hear?</span>
  </div>

  <!-- Answer Buttons -->
  <div class="note-buttons" id="answer-buttons"></div>

</div>

<script>
// Auth
const csrfToken = '{{ csrf_token }}';
let isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};

// Game state
let state = {
  correct: 0,
  total: 0,
  bestStreak: 0,
  streak: 0,
  currentNote: null,
  currentFreq: null,
  isPlaying: false,
  canAnswer: true
};

// Notes and frequencies
const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
const octaves = [3, 4, 5];

// Audio context - created and resumed on first user gesture
let audioCtx = null;

function getAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioCtx;
}

// Warm up AudioContext on first click (capture phase fires before button handlers)
document.addEventListener('click', function initAudioOnGesture() {
  const ctx = getAudioContext();
  if (ctx.state === 'suspended') {
    ctx.resume();
  }
  document.removeEventListener('click', initAudioOnGesture, true);
}, true);

// Calculate frequency for a note
function noteToFreq(note, octave) {
  const noteIndex = notes.indexOf(note);
  const semitonesFromA4 = (octave - 4) * 12 + (noteIndex - 9);
  return 440 * Math.pow(2, semitonesFromA4 / 12);
}

// Play a frequency
async function playFrequency(freq) {
  const ctx = getAudioContext();
  if (ctx.state === 'suspended') {
    try {
      await ctx.resume();
    } catch (err) {
      console.warn('Unable to resume AudioContext; audio will not play.', err);
      return;
    }
  }

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  
  osc.type = 'sine';
  osc.frequency.value = freq;
  
  gain.gain.setValueAtTime(0.3, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1);
  
  osc.connect(gain);
  gain.connect(ctx.destination);
  
  osc.start();
  osc.stop(ctx.currentTime + 1);
}

// Generate new question
function generateQuestion() {
  // Pick random note and octave
  const note = notes[Math.floor(Math.random() * notes.length)];
  const octave = octaves[Math.floor(Math.random() * octaves.length)];
  
  state.currentNote = note;
  state.currentFreq = noteToFreq(note, octave);
  
  // Generate answer buttons (correct + 5 wrong)
  const answers = new Set([note]);
  while (answers.size < 6) {
    answers.add(notes[Math.floor(Math.random() * notes.length)]);
  }
  
  // Shuffle and render buttons
  const shuffled = Array.from(answers).sort(() => Math.random() - 0.5);
  const container = document.getElementById('answer-buttons');
  container.innerHTML = shuffled.map(n => 
    `<button class="note-btn" data-note="${n}">${n}</button>`
  ).join('');
  
  // Add click handlers
  container.querySelectorAll('.note-btn').forEach(btn => {
    btn.addEventListener('click', () => checkAnswer(btn.dataset.note, btn));
  });
  
  document.getElementById('feedback').textContent = 'What note do you hear?';
  document.getElementById('feedback').className = 'feedback-text';
  
  state.canAnswer = true;
}

// Check answer
function checkAnswer(selected, btn) {
  if (!state.canAnswer) return;
  state.canAnswer = false;
  
  state.total++;
  const isCorrect = selected === state.currentNote;
  
  if (isCorrect) {
    state.correct++;
    state.streak++;
    if (state.streak > state.bestStreak) {
      state.bestStreak = state.streak;
    }
    btn.classList.add('correct');
    document.getElementById('feedback').innerHTML = '<i class="fas fa-check"></i> Correct!';
    document.getElementById('feedback').className = 'feedback-text feedback-correct';
  } else {
    state.streak = 0;
    btn.classList.add('incorrect');
    document.getElementById('feedback').innerHTML = `<i class="fas fa-times"></i> It was ${state.currentNote}`;
    document.getElementById('feedback').className = 'feedback-text feedback-incorrect';
  }
  
  updateStats();
  setTimeout(generateQuestion, isCorrect ? 800 : 1500);
}

// Update stats display
function updateStats() {
  document.getElementById('score').textContent = state.correct;
  document.getElementById('total').textContent = state.total;
  const accuracy = state.total > 0 ? Math.round((state.correct / state.total) * 100) : 0;
  document.getElementById('accuracy').textContent = accuracy + '%';
  
  // Show submit button when minimum attempts reached
  const submitSection = document.getElementById('submit-section');
  if (state.total >= 10 && isAuthenticated) {
    submitSection.style.display = 'block';
  }
}

// Submit score to leaderboard
async function submitToLeaderboard() {
  if (!isAuthenticated || state.total < 10) return;
  
  const btn = document.getElementById('submit-score');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
  
  try {
    const response = await fetch('/leaderboard/api/submit/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        game: 'pitch',
        difficulty: 'beginner',
        correct: state.correct,
        total: state.total,
        bestStreak: state.bestStreak
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      btn.innerHTML = '<i class="fas fa-check"></i> Submitted! Rank #' + data.rank;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-success');
      
      setTimeout(() => {
        state.correct = 0;
        state.total = 0;
        state.streak = 0;
        state.bestStreak = 0;
        updateStats();
        btn.innerHTML = '<i class="fas fa-trophy"></i> Submit to Leaderboard';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success');
        btn.disabled = false;
        document.getElementById('submit-section').style.display = 'none';
      }, 3000);
    } else {
      btn.innerHTML = '<i class="fas fa-times"></i> ' + data.error;
      btn.disabled = false;
    }
  } catch (error) {
    btn.innerHTML = '<i class="fas fa-times"></i> Error submitting';
    btn.disabled = false;
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('play-btn').addEventListener('click', function() {
    playFrequency(state.currentFreq);
  });
  
  generateQuestion();
});
</script>

{% endblock %}
