{% extends 'base.html' %}

{% block title %}Pitch Identification - Ear Training | R.I.T.H.M{% endblock %}
{% block meta_description %}Train your ear to identify musical pitches. Learn to recognize notes by ear with our free interactive game.{% endblock %}

{% block content %}

<style>
  .game-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .stats-card {
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-value {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
  }
  
  .stat-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .audio-section {
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .play-btn {
    background: var(--warning);
    border: none;
    color: white;
    padding: 1rem 2rem;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .play-btn:hover {
    background: #d97706;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
  }
  
  .play-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .feedback-text {
    font-size: 1.2rem;
    font-weight: 500;
    padding: 1rem 2rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
    display: inline-block;
  }
  
  .feedback-correct {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #6ee7b7;
  }
  
  .feedback-incorrect {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
  }
  
  .note-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .note-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    min-width: 80px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .note-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: var(--warning);
    transform: translateY(-2px);
  }
  
  .note-btn.correct {
    background: var(--success);
    border-color: var(--success);
  }
  
  .note-btn.incorrect {
    background: var(--danger);
    border-color: var(--danger);
  }
  
  .octave-indicator {
    font-size: 0.75rem;
    opacity: 0.7;
  }
</style>

<div class="game-container">
  
  <!-- Stats Card -->
  <div class="stats-card">
    <div class="row">
      <div class="col-4 stat-item">
        <div class="stat-value" id="score">0</div>
        <div class="stat-label">Score</div>
      </div>
      <div class="col-4 stat-item">
        <div class="stat-value" id="total">0</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="col-4 stat-item">
        <div class="stat-value" id="accuracy">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
    </div>
  </div>

  <!-- Audio Controls -->
  <div class="audio-section">
    <p style="color: rgba(255, 255, 255, 0.6); margin-bottom: 1.5rem;">
      Listen to the pitch and identify the note
    </p>
    <button id="play-btn" class="play-btn">
      <i class="fas fa-play"></i> Play Pitch
    </button>
  </div>

  <!-- Feedback -->
  <div class="d-flex justify-content-center mb-4">
    <span id="feedback" class="feedback-text">What note do you hear?</span>
  </div>

  <!-- Answer Buttons -->
  <div class="note-buttons" id="answer-buttons"></div>

</div>

<script>
// Game state
let state = {
  correct: 0,
  total: 0,
  currentNote: null,
  currentFreq: null,
  isPlaying: false,
  canAnswer: true
};

// Notes and frequencies
const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
const octaves = [3, 4, 5];

// Audio context
let audioCtx = null;

function getAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioCtx;
}

// Calculate frequency for a note
function noteToFreq(note, octave) {
  const noteIndex = notes.indexOf(note);
  const semitonesFromA4 = (octave - 4) * 12 + (noteIndex - 9);
  return 440 * Math.pow(2, semitonesFromA4 / 12);
}

// Play a frequency
function playFrequency(freq) {
  const ctx = getAudioContext();
  if (ctx.state === 'suspended') ctx.resume();
  
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  
  osc.type = 'sine';
  osc.frequency.value = freq;
  
  gain.gain.setValueAtTime(0.3, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1);
  
  osc.connect(gain);
  gain.connect(ctx.destination);
  
  osc.start();
  osc.stop(ctx.currentTime + 1);
}

// Generate new question
function generateQuestion() {
  // Pick random note and octave
  const note = notes[Math.floor(Math.random() * notes.length)];
  const octave = octaves[Math.floor(Math.random() * octaves.length)];
  
  state.currentNote = note;
  state.currentFreq = noteToFreq(note, octave);
  
  // Generate answer buttons (correct + 5 wrong)
  const answers = new Set([note]);
  while (answers.size < 6) {
    answers.add(notes[Math.floor(Math.random() * notes.length)]);
  }
  
  // Shuffle and render buttons
  const shuffled = Array.from(answers).sort(() => Math.random() - 0.5);
  const container = document.getElementById('answer-buttons');
  container.innerHTML = shuffled.map(n => 
    `<button class="note-btn" data-note="${n}">${n}</button>`
  ).join('');
  
  // Add click handlers
  container.querySelectorAll('.note-btn').forEach(btn => {
    btn.addEventListener('click', () => checkAnswer(btn.dataset.note, btn));
  });
  
  document.getElementById('feedback').textContent = 'What note do you hear?';
  document.getElementById('feedback').className = 'feedback-text';
  
  state.canAnswer = true;
}

// Check answer
function checkAnswer(selected, btn) {
  if (!state.canAnswer) return;
  state.canAnswer = false;
  
  state.total++;
  const isCorrect = selected === state.currentNote;
  
  if (isCorrect) {
    state.correct++;
    btn.classList.add('correct');
    document.getElementById('feedback').innerHTML = '<i class="fas fa-check"></i> Correct!';
    document.getElementById('feedback').className = 'feedback-text feedback-correct';
  } else {
    btn.classList.add('incorrect');
    document.getElementById('feedback').innerHTML = `<i class="fas fa-times"></i> It was ${state.currentNote}`;
    document.getElementById('feedback').className = 'feedback-text feedback-incorrect';
  }
  
  updateStats();
  setTimeout(generateQuestion, isCorrect ? 800 : 1500);
}

// Update stats display
function updateStats() {
  document.getElementById('score').textContent = state.correct;
  document.getElementById('total').textContent = state.total;
  const accuracy = state.total > 0 ? Math.round((state.correct / state.total) * 100) : 0;
  document.getElementById('accuracy').textContent = accuracy + '%';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('play-btn').addEventListener('click', function() {
    playFrequency(state.currentFreq);
  });
  
  generateQuestion();
});
</script>

{% endblock %}
