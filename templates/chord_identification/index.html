{% extends 'base.html' %}

{% block title %}Chord Identification - Learn Music Theory | R.I.T.H.M{% endblock %}
{% block meta_description %}Train your ear to identify chord types with our interactive game. Learn Major, Minor, Diminished, and Augmented chords with instant feedback and progress tracking.{% endblock %}
{% block og_title %}Chord Identification | R.I.T.H.M{% endblock %}
{% block og_description %}Master chord recognition with our interactive ear training game.{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "name": "Chord Identification Game",
  "description": "Interactive game to learn chord types and develop ear training skills",
  "provider": {
    "@type": "Organization",
    "name": "R.I.T.H.M"
  },
  "educationalLevel": "Beginner to Advanced",
  "learningResourceType": "Interactive Game",
  "inLanguage": "en"
}
</script>
{% endblock %}

{% block content %}

<style>
  .game-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .stats-card {
    background: var(--bg-card);
    backdrop-filter: blur(12px);
    border: 1px solid var(--input-bg);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-value {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
  }
  
  .stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.25rem;
  }
  
  .streak-fire {
    color: var(--warning) !important;
  }
  
  .difficulty-section {
    margin-bottom: 2rem;
  }
  
  .difficulty-btn {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 0.75rem 1.5rem;
    margin: 0;
    border-radius: 0;
    transition: all 0.3s ease;
  }
  
  .difficulty-btn:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
  }
  
  .difficulty-btn:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
  }
  
  .difficulty-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: var(--text-primary);
  }
  
  .difficulty-btn:hover {
    background: rgba(99, 102, 241, 0.3);
    border-color: var(--primary);
    color: var(--text-primary);
  }
  
  .audio-section {
    background: var(--bg-card);
    backdrop-filter: blur(12px);
    border: 1px solid var(--input-bg);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .play-btn {
    background: var(--primary);
    border: none;
    color: var(--text-primary);
    padding: 1rem 2rem;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .play-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
  }
  
  .play-btn:active {
    transform: translateY(0);
  }
  
  .play-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .chord-buttons {
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  
  .chord-btn {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 1rem 2rem;
    border-radius: 12px;
    transition: all 0.3s ease;
    cursor: pointer;
    font-weight: 500;
    min-width: 140px;
    font-size: 1.1rem;
  }
  
  .chord-btn:hover {
    background: var(--border-color);
    border-color: var(--primary);
    transform: translateY(-2px);
    color: var(--text-primary);
  }
  
  .chord-btn.correct {
    background: var(--success);
    border-color: var(--success);
    color: var(--text-primary);
  }
  
  .chord-btn.incorrect {
    background: var(--danger);
    border-color: var(--danger);
    color: var(--text-primary);
  }
  
  .chord-btn .chord-symbol {
    display: block;
    font-size: 0.85rem;
    opacity: 0.7;
    margin-top: 0.25rem;
  }
  
  .feedback-text {
    font-size: 1.2rem;
    font-weight: 500;
    padding: 1rem 2rem;
    border-radius: 12px;
    background: var(--input-bg);
    color: var(--text-secondary);
    transition: all 0.3s ease;
  }
  
  .feedback-correct {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #6ee7b7;
  }
  
  .feedback-incorrect {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
  }
  
  .settings-card {
    background: var(--bg-card);
    backdrop-filter: blur(12px);
    border: 1px solid var(--input-bg);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .setting-group {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  
  .setting-group:last-child {
    margin-bottom: 0;
  }
  
  .setting-label {
    color: var(--text-primary);
    font-weight: 500;
  }
  
  .setting-control {
    display: flex;
    gap: 0.5rem;
  }
  
  .setting-btn {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .setting-btn.active {
    background: var(--primary);
    border-color: var(--primary);
  }
  
  .setting-btn:hover {
    background: rgba(99, 102, 241, 0.3);
    border-color: var(--primary);
  }
  
  .chord-info {
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-top: 2rem;
    text-align: center;
  }
  
  .chord-info h5 {
    color: var(--primary);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .chord-info p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.9rem;
  }
  
  @media (max-width: 768px) {
    .chord-buttons {
      gap: 0.5rem;
    }
    
    .chord-btn {
      min-width: 100px;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
    }
  }
</style>

<div class="game-container">
  
  <!-- Stats Card -->
  <div class="stats-card">
    <div class="row">
      <div class="col-3 stat-item">
        <div class="stat-value" id="score">0</div>
        <div class="stat-label">Score</div>
      </div>
      <div class="col-3 stat-item">
        <div class="stat-value" id="streak">0 <i class="fas fa-fire" style="color: #f59e0b;"></i></div>
        <div class="stat-label">Streak</div>
      </div>
      <div class="col-3 stat-item">
        <div class="stat-value" id="accuracy">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
      <div class="col-3 stat-item">
        <div class="stat-value" id="best-streak">0</div>
        <div class="stat-label">Best</div>
      </div>
    </div>
    <div class="text-center mt-3" id="submit-section" style="display: none;">
      <button id="submit-score" class="btn btn-success" onclick="submitToLeaderboard()">
        <i class="fas fa-trophy"></i> Submit to Leaderboard
      </button>
      <p class="mt-2 mb-0" style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">Minimum 10 attempts required</p>
    </div>
  </div>

  <!-- Difficulty Selection -->
  <div class="difficulty-section d-flex justify-content-center">
    <div class="btn-group" role="group">
      <button type="button" class="btn difficulty-btn active" data-level="beginner" onclick="setDifficulty('beginner')">
        <i class="fas fa-seedling"></i> Beginner
      </button>
      <button type="button" class="btn difficulty-btn" data-level="intermediate" onclick="setDifficulty('intermediate')">
        <i class="fas fa-leaf"></i> Intermediate
      </button>
      <button type="button" class="btn difficulty-btn" data-level="advanced" onclick="setDifficulty('advanced')">
        <i class="fas fa-tree"></i> Advanced
      </button>
    </div>
  </div>

  <!-- Settings Card -->
  <div class="settings-card">
    <div class="setting-group">
      <span class="setting-label">Play Style</span>
      <div class="setting-control">
        <button class="setting-btn active" data-style="harmonic" onclick="setPlayStyle('harmonic')">
          <i class="fas fa-layer-group"></i> Block
        </button>
        <button class="setting-btn" data-style="arpeggio" onclick="setPlayStyle('arpeggio')">
          <i class="fas fa-water"></i> Arpeggio
        </button>
      </div>
    </div>
  </div>

  <!-- Audio Controls -->
  <div class="audio-section">
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
      Listen to the chord and identify its type
    </p>
    
    <button id="play-chord" class="play-btn">
      <i class="fas fa-play"></i> Play Chord
    </button>
    
    <button id="replay-chord" class="play-btn" style="margin-left: 1rem;">
      <i class="fas fa-redo"></i> Replay
    </button>
  </div>

  <!-- Feedback Text -->
  <div class="d-flex justify-content-center mb-4">
    <span id="feedback" class="feedback-text">What chord do you hear?</span>
  </div>

  <!-- Answer Buttons - Beginner (Major/Minor only) -->
  <div class="chord-buttons" id="beginner-chords">
    <button type="button" class="chord-btn" data-chord="major">
      Major
      <span class="chord-symbol">C, D, E...</span>
    </button>
    <button type="button" class="chord-btn" data-chord="minor">
      Minor
      <span class="chord-symbol">Cm, Dm, Em...</span>
    </button>
  </div>

  <!-- Answer Buttons - Intermediate (All 4 types) -->
  <div class="chord-buttons" id="intermediate-chords" style="display: none;">
    <button type="button" class="chord-btn" data-chord="major">
      Major
      <span class="chord-symbol">Bright, Happy</span>
    </button>
    <button type="button" class="chord-btn" data-chord="minor">
      Minor
      <span class="chord-symbol">Dark, Sad</span>
    </button>
    <button type="button" class="chord-btn" data-chord="diminished">
      Diminished
      <span class="chord-symbol">Tense, Unstable</span>
    </button>
    <button type="button" class="chord-btn" data-chord="augmented">
      Augmented
      <span class="chord-symbol">Dreamy, Suspended</span>
    </button>
  </div>

  <!-- Answer Buttons - Advanced (All types + inversions) -->
  <div class="chord-buttons" id="advanced-chords" style="display: none;">
    <button type="button" class="chord-btn" data-chord="major">
      Major
      <span class="chord-symbol">Root Position</span>
    </button>
    <button type="button" class="chord-btn" data-chord="minor">
      Minor
      <span class="chord-symbol">Root Position</span>
    </button>
    <button type="button" class="chord-btn" data-chord="diminished">
      Diminished
      <span class="chord-symbol">Root Position</span>
    </button>
    <button type="button" class="chord-btn" data-chord="augmented">
      Augmented
      <span class="chord-symbol">Root Position</span>
    </button>
    <button type="button" class="chord-btn" data-chord="major7">
      Major 7th
      <span class="chord-symbol">Cmaj7</span>
    </button>
    <button type="button" class="chord-btn" data-chord="minor7">
      Minor 7th
      <span class="chord-symbol">Cm7</span>
    </button>
    <button type="button" class="chord-btn" data-chord="dominant7">
      Dominant 7th
      <span class="chord-symbol">C7</span>
    </button>
  </div>

  <!-- Chord Info -->
  <div class="chord-info">
    <h5><i class="fas fa-info-circle"></i> Chord Reference</h5>
    <p>
      <strong>Major:</strong> Happy, bright (R-M3-P5) &nbsp;|&nbsp;
      <strong>Minor:</strong> Sad, dark (R-m3-P5) &nbsp;|&nbsp;
      <strong>Dim:</strong> Tense (R-m3-d5) &nbsp;|&nbsp;
      <strong>Aug:</strong> Dreamy (R-M3-A5)
    </p>
  </div>

</div>

<script>
// CSRF token for API calls
const csrfToken = '{{ csrf_token }}';
let isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
let saveTimeout = null;

// Game State
let state = {
  correct: 0,
  total: 0,
  streak: 0,
  bestStreak: 0,
  difficulty: 'beginner',
  playStyle: 'harmonic',
  currentChord: null,
  currentRootNote: null,
  isPlaying: false,
  canAnswer: true
};

// Chord definitions (semitones from root)
const chords = {
  'major': [0, 4, 7],           // Root, Major 3rd, Perfect 5th
  'minor': [0, 3, 7],           // Root, Minor 3rd, Perfect 5th
  'diminished': [0, 3, 6],      // Root, Minor 3rd, Diminished 5th
  'augmented': [0, 4, 8],       // Root, Major 3rd, Augmented 5th
  'major7': [0, 4, 7, 11],      // Root, M3, P5, Major 7th
  'minor7': [0, 3, 7, 10],      // Root, m3, P5, Minor 7th
  'dominant7': [0, 4, 7, 10]    // Root, M3, P5, Minor 7th
};

// Chord names for display
const chordNames = {
  'major': 'Major',
  'minor': 'Minor',
  'diminished': 'Diminished',
  'augmented': 'Augmented',
  'major7': 'Major 7th',
  'minor7': 'Minor 7th',
  'dominant7': 'Dominant 7th'
};

// Chord sets by difficulty
const chordSets = {
  beginner: ['major', 'minor'],
  intermediate: ['major', 'minor', 'diminished', 'augmented'],
  advanced: ['major', 'minor', 'diminished', 'augmented', 'major7', 'minor7', 'dominant7']
};

// Audio context - created and resumed on first user gesture
let audioCtx = null;

function getAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioCtx;
}

// Warm up AudioContext on first click (capture phase fires before button handlers)
document.addEventListener('click', function initAudioOnGesture() {
  const ctx = getAudioContext();
  if (ctx.state === 'suspended') {
    ctx.resume();
  }
  document.removeEventListener('click', initAudioOnGesture, true);
}, true);

// Play a single note using Web Audio API
function playNote(frequency, startTime, duration, volume = 0.25) {
  const ctx = getAudioContext();
  
  const oscillator = ctx.createOscillator();
  const gainNode = ctx.createGain();
  
  oscillator.type = 'sine';
  oscillator.frequency.value = frequency;
  
  gainNode.gain.setValueAtTime(0, startTime);
  gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.05);
  gainNode.gain.setValueAtTime(volume, startTime + duration - 0.15);
  gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
  
  oscillator.connect(gainNode);
  gainNode.connect(ctx.destination);
  
  oscillator.start(startTime);
  oscillator.stop(startTime + duration);
}

// Convert MIDI note number to frequency
function midiToFreq(midiNote) {
  return 440 * Math.pow(2, (midiNote - 69) / 12);
}

// Get MIDI note number from note name
function noteToMidi(note) {
  const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  const octave = parseInt(note.slice(-1));
  const noteName = note.slice(0, -1);
  const noteIndex = notes.indexOf(noteName);
  
  return (octave + 1) * 12 + noteIndex;
}

// Load stats from server (if we have a chord stats API)
async function loadStats() {
  if (!isAuthenticated) return;
  
  try {
    const response = await fetch('/accounts/api/chord-stats/');
    const data = await response.json();
    
    if (data.authenticated && data.stats) {
      state.correct = data.stats.correct || 0;
      state.total = data.stats.total || 0;
      state.streak = data.stats.streak || 0;
      state.bestStreak = data.stats.bestStreak || 0;
      
      if (data.stats.difficulty) {
        state.difficulty = data.stats.difficulty;
      }
      
      updateStatsDisplay();
    }
  } catch (error) {
    // API might not exist yet, that's okay
    console.log('Chord stats API not available yet');
  }
}

// Save stats to server (debounced)
function saveStats() {
  if (!isAuthenticated) return;
  
  if (saveTimeout) clearTimeout(saveTimeout);
  
  saveTimeout = setTimeout(async () => {
    try {
      await fetch('/accounts/api/chord-stats/update/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          correct: state.correct,
          total: state.total,
          streak: state.streak,
          bestStreak: state.bestStreak,
          difficulty: state.difficulty
        })
      });
    } catch (error) {
      console.log('Chord stats save not available yet');
    }
  }, 1000);
}

// Set difficulty level
function setDifficulty(level) {
  state.difficulty = level;
  
  document.querySelectorAll('.difficulty-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.level === level);
  });
  
  // Show/hide appropriate chord buttons
  document.querySelectorAll('.chord-buttons').forEach(group => {
    group.style.display = 'none';
  });
  document.getElementById(level + '-chords').style.display = 'flex';
  
  generateNewChord();
}

// Set play style
function setPlayStyle(style) {
  state.playStyle = style;
  
  document.querySelectorAll('[data-style]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.style === style);
  });
}

// Generate a new chord
function generateNewChord() {
  const availableChords = chordSets[state.difficulty];
  state.currentChord = availableChords[Math.floor(Math.random() * availableChords.length)];
  
  // Random root note (MIDI notes 48-60, C3-C4)
  const rootNotes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4'];
  state.currentRootNote = rootNotes[Math.floor(Math.random() * rootNotes.length)];
  
  document.getElementById('feedback').textContent = 'What chord do you hear?';
  document.getElementById('feedback').className = 'feedback-text';
  
  state.canAnswer = true;
}

// Play the current chord
async function playCurrentChord() {
  if (state.isPlaying) return;

  // Resume audio context if suspended (must await before scheduling)
  const ctx = getAudioContext();
  if (ctx.state === 'suspended') {
    await ctx.resume();
  }

  state.isPlaying = true;

  const playBtn = document.getElementById('play-chord');
  const replayBtn = document.getElementById('replay-chord');
  playBtn.disabled = true;
  replayBtn.disabled = true;

  const rootMidi = noteToMidi(state.currentRootNote);
  const chordIntervals = chords[state.currentChord];
  const now = ctx.currentTime;
  
  if (state.playStyle === 'harmonic') {
    // Play all notes together
    const duration = 1.2;
    chordIntervals.forEach(interval => {
      const freq = midiToFreq(rootMidi + interval);
      playNote(freq, now, duration, 0.2);
    });
    
    setTimeout(() => {
      playBtn.disabled = false;
      replayBtn.disabled = false;
      state.isPlaying = false;
    }, 1400);
  } else {
    // Arpeggio - play notes one by one
    const noteDuration = 0.4;
    const gap = 0.35;
    
    chordIntervals.forEach((interval, i) => {
      const freq = midiToFreq(rootMidi + interval);
      playNote(freq, now + (i * gap), noteDuration, 0.25);
    });
    
    const totalDuration = (chordIntervals.length * gap + noteDuration) * 1000 + 200;
    setTimeout(() => {
      playBtn.disabled = false;
      replayBtn.disabled = false;
      state.isPlaying = false;
    }, totalDuration);
  }
}

// Check answer
function checkAnswer(selectedChord) {
  if (!state.canAnswer || state.isPlaying) return;
  
  state.canAnswer = false;
  const isCorrect = selectedChord === state.currentChord;
  
  state.total++;
  
  const feedbackEl = document.getElementById('feedback');
  const selectedBtn = document.querySelector(`#${state.difficulty}-chords [data-chord="${selectedChord}"]`);
  
  if (isCorrect) {
    state.correct++;
    state.streak++;
    if (state.streak > state.bestStreak) {
      state.bestStreak = state.streak;
    }
    
    feedbackEl.innerHTML = '<i class="fas fa-check"></i> Correct!';
    feedbackEl.className = 'feedback-text feedback-correct';
    
    if (selectedBtn) {
      selectedBtn.classList.add('correct');
      setTimeout(() => selectedBtn.classList.remove('correct'), 500);
    }
    
    setTimeout(generateNewChord, 800);
  } else {
    state.streak = 0;
    
    const correctName = chordNames[state.currentChord];
    
    feedbackEl.innerHTML = `<i class="fas fa-times"></i> It was ${correctName}`;
    feedbackEl.className = 'feedback-text feedback-incorrect';
    
    if (selectedBtn) {
      selectedBtn.classList.add('incorrect');
      setTimeout(() => selectedBtn.classList.remove('incorrect'), 500);
    }
    
    // Highlight the correct answer
    const correctBtn = document.querySelector(`#${state.difficulty}-chords [data-chord="${state.currentChord}"]`);
    if (correctBtn) {
      correctBtn.classList.add('correct');
      setTimeout(() => correctBtn.classList.remove('correct'), 1500);
    }
    
    setTimeout(generateNewChord, 1500);
  }
  
  updateStatsDisplay();
  saveStats();
}

// Update stats display
function updateStatsDisplay() {
  document.getElementById('score').textContent = state.correct;
  
  const streakEl = document.getElementById('streak');
  streakEl.innerHTML = state.streak + ' <i class="fas fa-fire" style="color: #f59e0b;"></i>';
  streakEl.classList.toggle('streak-fire', state.streak >= 5);
  
  document.getElementById('best-streak').textContent = state.bestStreak;
  
  const accuracy = state.total > 0 ? Math.round((state.correct / state.total) * 100) : 0;
  document.getElementById('accuracy').textContent = accuracy + '%';
  
  // Show submit button when minimum attempts reached
  const submitSection = document.getElementById('submit-section');
  if (state.total >= 10 && isAuthenticated) {
    submitSection.style.display = 'block';
  }
}

// Submit score to leaderboard
async function submitToLeaderboard() {
  if (!isAuthenticated || state.total < 10) return;
  
  const btn = document.getElementById('submit-score');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
  
  try {
    const response = await fetch('/leaderboard/api/submit/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        game: 'chord',
        difficulty: state.difficulty,
        correct: state.correct,
        total: state.total,
        bestStreak: state.bestStreak
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      btn.innerHTML = '<i class="fas fa-check"></i> Submitted! Rank #' + data.rank;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-success');
      
      // Reset for new session
      setTimeout(() => {
        state.correct = 0;
        state.total = 0;
        state.streak = 0;
        updateStatsDisplay();
        btn.innerHTML = '<i class="fas fa-trophy"></i> Submit to Leaderboard';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success');
        btn.disabled = false;
        document.getElementById('submit-section').style.display = 'none';
      }, 3000);
    } else {
      btn.innerHTML = '<i class="fas fa-times"></i> ' + (data.error || 'Error');
      btn.disabled = false;
    }
  } catch (error) {
    btn.innerHTML = '<i class="fas fa-times"></i> Error submitting';
    btn.disabled = false;
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Attach click handlers to ALL chord buttons
  document.querySelectorAll('.chord-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      checkAnswer(this.dataset.chord);
    });
  });
  
  // Attach click handlers to play buttons
  document.getElementById('play-chord').addEventListener('click', playCurrentChord);
  document.getElementById('replay-chord').addEventListener('click', playCurrentChord);
  
  // Set initial difficulty
  setDifficulty(state.difficulty);
  
  // Load saved stats
  loadStats();
  
  updateStatsDisplay();
});
</script>

{% endblock %}
