<!-- Keyboard Container -->
<div id="key_container"></div>

<!-- Synth Selector -->
<div class="synth-controls" id="synth_selector_button"></div>

<script>
  // Init synths
  var poly_synth = new Tone.PolySynth(Tone.Synth, 8).toDestination();
  var fm_synth = new Tone.PolySynth(Tone.FMSynth).toDestination();
  var poly_synth_active = true;
  var fm_synth_active = false;
  
  // Create synth selector buttons
  var synth_list = [
    { id: "poly_synth", name: "Poly Synth", icon: "fa-wave-square" },
    { id: "FM_synth", name: "FM Synth", icon: "fa-broadcast-tower" }
  ];
  
  var synth_button_html = "";
  for (var i = 0; i < synth_list.length; i++) {
    var activeClass = i === 0 ? "active" : "";
    synth_button_html += `<button class='synth-btn ${activeClass}' id='${synth_list[i].id}' onclick='select_synth(this)' data-synth='${synth_list[i].id}'>
      <i class="fas ${synth_list[i].icon}"></i> ${synth_list[i].name}
    </button>`;
  }
  document.getElementById("synth_selector_button").innerHTML = synth_button_html;

  // Keyboard notes
  var notes = ["C", "D", "E", "F", "G", "A", "B"];
  var html = "";
  
  // Creates 2 octaves
  for (var octave = 0; octave < 2; octave++) {
    for (var i = 0; i < notes.length; i++) {
      var note = notes[i];
      var has_sharp = note != "E" && note != "B";
      
      html += `<div class='white_note' id='${note + (octave + 4)}' 
               onmousedown='note_down(this,false)' 
               onmouseup='note_up(this,false)' 
               onmouseleave='note_up(this,false)' 
               data-note='${note + (octave + 4)}'>`;
      
      if (has_sharp) {
        html += `<div class='black_note' id='${note + "#" + (octave + 4)}' 
                 onmousedown='note_down(this,true)' 
                 onmouseup='note_up(this,true)' 
                 onmouseleave='note_up(this,true)' 
                 data-note='${note + "#" + (octave + 4)}'></div>`;
      }
      html += `</div>`;
    }
  }
  
  document.getElementById("key_container").innerHTML = html;

  // Keyboard mappings
  var keyMap = {
    65: "C4", 87: "C#4", 83: "D4", 69: "D#4", 68: "E4", 
    70: "F4", 84: "F#4", 71: "G4", 89: "G#4", 72: "A4", 
    85: "A#4", 74: "B4"
  };
  
  var pressedKeys = {};
  
  document.addEventListener("keydown", function(e) {
    if (keyMap[e.keyCode] && !pressedKeys[e.keyCode]) {
      pressedKeys[e.keyCode] = true;
      var note = keyMap[e.keyCode];
      var elem = document.getElementById(note);
      if (elem) {
        var isSharp = note.includes("#");
        note_down(elem, isSharp);
      }
    }
  });
  
  document.addEventListener("keyup", function(e) {
    if (keyMap[e.keyCode]) {
      pressedKeys[e.keyCode] = false;
      var note = keyMap[e.keyCode];
      var elem = document.getElementById(note);
      if (elem) {
        var isSharp = note.includes("#");
        note_up(elem, isSharp);
      }
    }
  });

  function note_up(elem, is_sharp) {
    var note = elem.dataset.note;
    elem.classList.remove('active');
    
    if (poly_synth_active) {
      poly_synth.triggerRelease(note);
    } else if (fm_synth_active) {
      fm_synth.triggerRelease(note);
    }
  }

  function note_down(elem, is_sharp) {
    var note = elem.dataset.note;
    elem.classList.add('active');
    
    if (poly_synth_active) {
      poly_synth.triggerAttack(note);
    } else if (fm_synth_active) {
      fm_synth.triggerAttack(note);
    }
    
    if (event) event.stopPropagation();
  }

  function select_synth(elem) {
    // Update active states
    document.querySelectorAll('.synth-btn').forEach(btn => btn.classList.remove('active'));
    elem.classList.add('active');
    
    if (elem.id === "poly_synth") {
      fm_synth_active = false;
      poly_synth_active = true;
    } else if (elem.id === "FM_synth") {
      fm_synth_active = true;
      poly_synth_active = false;
    }
  }
</script>
