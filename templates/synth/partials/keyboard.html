<!-- Audio Start Overlay (for mobile) -->
<div id="audio-start-overlay" style="
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15, 23, 42, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  border-radius: 12px;
  cursor: pointer;
">
  <div style="text-align: center;">
    <i class="fas fa-volume-up" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
    <p style="color: white; font-size: 1.2rem; margin: 0;">Tap to Enable Audio</p>
  </div>
</div>

<!-- Keyboard Container -->
<div id="key_container"></div>

<!-- Synth Selector -->
<div class="synth-controls" id="synth_selector_button"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script>
  // Audio state
  var audioStarted = false;
  var poly_synth = null;
  var fm_synth = null;
  var poly_synth_active = true;
  var fm_synth_active = false;
  
  // Initialize audio on user interaction
  async function initAudio() {
    if (audioStarted) return;
    
    try {
      await Tone.start();
      
      poly_synth = new Tone.PolySynth(Tone.Synth, 8).toDestination();
      fm_synth = new Tone.PolySynth(Tone.FMSynth).toDestination();
      
      audioStarted = true;
      
      // Hide the overlay
      document.getElementById('audio-start-overlay').style.display = 'none';
      
      console.log('Audio initialized');
    } catch (error) {
      console.error('Failed to init audio:', error);
    }
  }
  
  // Click handler for the overlay
  document.getElementById('audio-start-overlay').addEventListener('click', initAudio);
  document.getElementById('audio-start-overlay').addEventListener('touchstart', initAudio);
  
  // Create synth selector buttons
  var synth_list = [
    { id: "poly_synth", name: "Poly Synth", icon: "fa-wave-square" },
    { id: "FM_synth", name: "FM Synth", icon: "fa-broadcast-tower" }
  ];
  
  var synth_button_html = "";
  for (var i = 0; i < synth_list.length; i++) {
    var activeClass = i === 0 ? "active" : "";
    synth_button_html += `<button class='synth-btn ${activeClass}' id='${synth_list[i].id}' onclick='select_synth(this)' data-synth='${synth_list[i].id}'>
      <i class="fas ${synth_list[i].icon}"></i> ${synth_list[i].name}
    </button>`;
  }
  document.getElementById("synth_selector_button").innerHTML = synth_button_html;

  // Keyboard notes
  var notes = ["C", "D", "E", "F", "G", "A", "B"];
  var html = "";
  
  // Creates 2 octaves
  for (var octave = 0; octave < 2; octave++) {
    for (var i = 0; i < notes.length; i++) {
      var note = notes[i];
      var has_sharp = note != "E" && note != "B";
      
      html += `<div class='white_note' id='${note + (octave + 4)}' 
               data-note='${note + (octave + 4)}'>`;
      
      if (has_sharp) {
        html += `<div class='black_note' id='${note + "#" + (octave + 4)}' 
                 data-note='${note + "#" + (octave + 4)}'></div>`;
      }
      html += `</div>`;
    }
  }
  
  document.getElementById("key_container").innerHTML = html;
  
  // Add touch/mouse handlers to all keys
  document.querySelectorAll('.white_note, .black_note').forEach(function(key) {
    var isSharp = key.classList.contains('black_note');
    
    // Mouse events
    key.addEventListener('mousedown', function(e) {
      e.preventDefault();
      note_down(this, isSharp);
    });
    key.addEventListener('mouseup', function(e) {
      note_up(this, isSharp);
    });
    key.addEventListener('mouseleave', function(e) {
      note_up(this, isSharp);
    });
    
    // Touch events for mobile
    key.addEventListener('touchstart', function(e) {
      e.preventDefault();
      initAudio().then(function() {
        note_down(key, isSharp);
      });
    });
    key.addEventListener('touchend', function(e) {
      e.preventDefault();
      note_up(key, isSharp);
    });
  });

  // Keyboard mappings
  var keyMap = {
    65: "C4", 87: "C#4", 83: "D4", 69: "D#4", 68: "E4", 
    70: "F4", 84: "F#4", 71: "G4", 89: "G#4", 72: "A4", 
    85: "A#4", 74: "B4"
  };
  
  var pressedKeys = {};
  
  document.addEventListener("keydown", async function(e) {
    if (keyMap[e.keyCode] && !pressedKeys[e.keyCode]) {
      await initAudio();
      pressedKeys[e.keyCode] = true;
      var note = keyMap[e.keyCode];
      var elem = document.getElementById(note);
      if (elem) {
        var isSharp = note.includes("#");
        note_down(elem, isSharp);
      }
    }
  });
  
  document.addEventListener("keyup", function(e) {
    if (keyMap[e.keyCode]) {
      pressedKeys[e.keyCode] = false;
      var note = keyMap[e.keyCode];
      var elem = document.getElementById(note);
      if (elem) {
        var isSharp = note.includes("#");
        note_up(elem, isSharp);
      }
    }
  });

  function note_up(elem, is_sharp) {
    if (!audioStarted) return;
    
    var note = elem.dataset.note;
    elem.classList.remove('active');
    
    if (poly_synth_active && poly_synth) {
      poly_synth.triggerRelease(note);
    } else if (fm_synth_active && fm_synth) {
      fm_synth.triggerRelease(note);
    }
  }

  function note_down(elem, is_sharp) {
    if (!audioStarted) return;
    
    var note = elem.dataset.note;
    elem.classList.add('active');
    
    if (poly_synth_active && poly_synth) {
      poly_synth.triggerAttack(note);
    } else if (fm_synth_active && fm_synth) {
      fm_synth.triggerAttack(note);
    }
  }

  function select_synth(elem) {
    // Update active states
    document.querySelectorAll('.synth-btn').forEach(btn => btn.classList.remove('active'));
    elem.classList.add('active');
    
    if (elem.id === "poly_synth") {
      fm_synth_active = false;
      poly_synth_active = true;
    } else if (elem.id === "FM_synth") {
      fm_synth_active = true;
      poly_synth_active = false;
    }
  }
</script>
